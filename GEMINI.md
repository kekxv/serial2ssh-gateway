# GEMINI.md

## 项目名称：基于 Go 语言的串口到 SSH 协议转换网关 (Serial-to-SSH Gateway)

### 1. 项目目标
开发一个跨平台（兼容 Windows 7/10/11, Linux, macOS）的单文件 Go 应用程序。
该程序运行在“服务端”电脑上，监听指定的物理串口。当用户通过串口线连接时，程序会在串口终端上引导用户输入 SSH 服务器信息，并建立 SSH 连接。
**核心要求**：必须支持二进制透明传输，以完美支持 `sz` 和 `rz` (Zmodem) 文件传输协议，并能在 Windows 7 上流畅运行。

### 2. 技术栈要求
*   **编程语言**: Go (Golang)
*   **TUI 界面框架**: `github.com/charmbracelet/bubbletea` (用于在服务端显示运行状态和日志)
*   **串口通信库**: `go.bug.st/serial` (要求跨平台稳定性高)
*   **SSH 客户端库**: `golang.org/x/crypto/ssh` (原生实现，不依赖外部 ssh 命令)

### 3. 系统架构设计
程序需包含两个并发运行的主要部分：
1.  **UI 主线程 (Bubble Tea)**: 负责在本地屏幕上渲染 TUI 界面，显示标题、当前监听端口、波特率以及滚动的连接日志。
2.  **业务逻辑协程 (Background Goroutine)**: 负责处理阻塞式的串口 I/O 和 SSH 会话逻辑，并通过 Channel 或回调将日志实时发送给 UI 线程。

### 4. 详细功能需求

#### A. 串口配置 (关键：Zmodem 支持)
为了确保 `sz`/`rz` 等文件传输工具正常工作，串口配置必须严格遵循以下标准：
*   **基本参数**: N-8-1 (无校验, 8位数据位, 1位停止位)。
*   **流控 (Flow Control)**: 必须**强制关闭**所有流控。
    *   禁用软件流控 (XON/XOFF)，防止二进制文件中的 `0x11`/`0x13` 字节导致传输中断。
    *   禁用硬件流控 (RTS/CTS)。
*   **波特率**: 定义为常量（如 115200），方便修改。

#### B. 阶段一：串口登录交互 (Login Phase)
当串口打开后，程序应向串口发送欢迎信息，并进入循环：
1.  **提示输入目标 IP**: (例如 `192.168.1.10:22`)，支持默认端口 22。
2.  **提示输入用户名**: 支持退格键 (`Backspace`/`Del`) 修改输入。
3.  **提示输入密码**: 输入时需进行掩码处理（回显为 `*`），同样支持退格。
*   *注意*: 此阶段需手动处理串口输入的行缓冲和回显。

#### C. 阶段二：SSH 透传会话 (Passthrough Phase)
获取凭据后，使用 `ssh.Dial` 建立连接：
1.  **PTY 请求**: 必须申请伪终端 (`RequestPty`)，类型设为 `xterm`。
    *   **TerminalModes**: 设置 `ECHO: 1` (开启回显), `CS8: 1` (8-bit 数据), `IGNPAR: 1` (忽略校验)。
2.  **数据流桥接 (核心)**:
    *   将串口的 `Read` 直接绑定到 SSH Session 的 `Stdin`。
    *   将 SSH Session 的 `Stdout` 和 `Stderr` 直接绑定到串口的 `Write`。
    *   **实现方式**: 使用 `io.Copy` 进行字节级透传，不要对数据流进行任何中间处理（如字符替换），以保证二进制文件的完整性。
3.  **会话结束**: 当 SSH 连接断开或用户输入 `exit` 后，程序不应退出，而是回到“阶段一”，等待下一次连接。

#### D. 服务端 UI 展示
本地运行程序的屏幕应显示：
*   程序标题与版本。
*   当前监听的串口号与状态。
*   **日志区域**: 实时显示操作日志（如 "串口已打开", "正在连接到 192.168.x.x...", "SSH 会话结束"）。
*   支持按 `Ctrl+C` 安全退出整个程序。

### 5. 兼容性与约束
1.  **Windows 7 兼容**: 代码中严禁使用 `os/exec` 调用本地的 `cmd.exe`、`powershell` 或依赖 `conpty`。所有终端交互必须完全封装在 Go 代码和 SSH 协议内部。
2.  **错误处理**: 网络超时、认证失败或串口拔出时，程序不应崩溃，应记录错误日志并重置状态。

### 6. 输出要求
请生成一个完整的 `main.go` 文件。代码结构应清晰，包含必要的注释，Model 定义和逻辑处理分离。请确保包含 `readLine` 辅助函数来处理串口输入的退格和密码掩码逻辑。

